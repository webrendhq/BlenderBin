<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import { getFunctions } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-functions.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDIuu33lWChgE_oTteuAuywPrJwBFiRavM",
      authDomain: "marv-studio-points-plugin.firebaseapp.com",
      projectId: "marv-studio-points-plugin",
      storageBucket: "marv-studio-points-plugin.appspot.com",
      messagingSenderId: "441089628814",
      appId: "1:441089628814:web:4b4bc410399ae288bd47df"
    };
    
    // Initialize Firebase and declare "global" variables
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, "us-central1");
    
    // Identify auth action forms
    let signUpForm = document.getElementById('wf-form-signup-form');
    let signInForm = document.getElementById('wf-form-signin-form');
    let signOutButton = document.getElementById('signout-button');
    let buyBlenderBinButton = document.getElementById('buy-blenderbin-button');
    let downloadBlenderBinButton = document.getElementById('download-blenderbin');
    let cancelSubscriptionButton = document.getElementById('cancel-subscription-button');
    let pluginButtonsMain = document.getElementById('plugin-buttons-main');
    
    // Assign event listeners, if the elements exist
    if (signUpForm !== null) {
      signUpForm.addEventListener('submit', handleSignUp, true);
    }
    
    if (signInForm !== null) {
      signInForm.addEventListener('submit', handleSignIn, true);
    }
    
    if (signOutButton !== null) {
      signOutButton.addEventListener('click', handleSignOut);
    }
    
    if (buyBlenderBinButton !== null) {
      buyBlenderBinButton.addEventListener('click', buyBlenderBin);
    }
    
    if (downloadBlenderBinButton !== null) {
      downloadBlenderBinButton.addEventListener('click', downloadBlenderBin);
    }
    
    // Function to get subscription ID from Firestore
    async function getSubscriptionId(user) {
      try {
        const subscriptionsRef = collection(db, "customers", user.uid, "subscriptions");
        const querySnapshot = await getDocs(subscriptionsRef);
    
        let subscriptionId = null;
    
        console.log(`Retrieved ${querySnapshot.size} documents from subscriptions collection.`);
    
        querySnapshot.forEach((doc) => {
          const subscriptionData = doc.data();
          console.log("Subscription document data:", subscriptionData);
    
          // Check if the status is active and extract the subscription ID from the stripeLink field
          if (subscriptionData.status === "active" && subscriptionData.stripeLink) {
            const stripeLink = subscriptionData.stripeLink;
            // Extract the subscription ID from the stripeLink URL
            const urlParts = stripeLink.split('/');
            subscriptionId = urlParts[urlParts.length - 1]; // Get the last part of the URL
            console.log(`Extracted subscription ID: ${subscriptionId}`);
          }
        });
    
        if (!subscriptionId) {
          throw new Error('No active subscription found.');
        }
    
        return subscriptionId;
      } catch (error) {
        console.error('Error getting subscription ID:', error);
        throw error;
      }
    }
    
    
    // Custom error messages based on Firebase error codes
    function getCustomErrorMessage(errorCode) {
      switch (errorCode) {
        case 'auth/user-not-found':
          return 'Account does not exist or Password is incorrect. Please try again.';
        case 'auth/wrong-password':
          return 'Account does not exist or Password is incorrect. Please try again.';
        case 'auth/email-already-in-use':
          return 'The email address is already in use by another account.';
        case 'auth/weak-password':
          return 'The password is too weak. Please choose a stronger password.';
        case 'auth/invalid-email':
          return 'The email address is not valid. Please enter a correct email.';
        default:
          return 'An unexpected error occurred. Please try again.';
      }
    }
    
    // Handle signUp
    function handleSignUp(e) {
      e.preventDefault();
      e.stopPropagation();
    
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
    
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          console.log('User successfully created: ' + user.email);
          window.location.href = "https://blenderbin.com";
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = getCustomErrorMessage(errorCode);
          var errorText = document.getElementById('signup-error-message');
          errorText.innerHTML = errorMessage;
        });
    }
    
    // Handle signIn
    function handleSignIn(e) {
      e.preventDefault();
      e.stopPropagation();
    
      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;
    
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          console.log('User logged in: ' + user.email);
          window.location.href = "https://blenderbin.com";
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = getCustomErrorMessage(errorCode);
          var errorText = document.getElementById('signin-error-message');
          errorText.innerHTML = errorMessage;
        });
    }
    
    // Handle signOut
    function handleSignOut() {
      signOut(auth).then(() => {
        console.log('User signed out');
        window.location.reload();
      }).catch((error) => {
        const errorMessage = error.message;
        console.log(errorMessage);
      });
    }
    
    // Assign event listeners, if the elements exist
    if (cancelSubscriptionButton !== null) {
      cancelSubscriptionButton.addEventListener('click', async () => {
        try {
          const user = auth.currentUser;
          if (!user) {
            throw new Error('User is not authenticated.');
          }
    
          const subscriptionId = await getSubscriptionId(user); // Get the subscription ID from Firestore
          await cancelSubscription(subscriptionId); // Cancel the subscription using the retrieved ID
          
          // Reload the window after successful subscription cancellation
          window.location.reload();
    
        } catch (error) {
          console.error('Error during subscription cancellation:', error);
        }
      });
    }
    
    // Function to cancel subscription
    async function cancelSubscription(subscriptionId) {
      try {
        const user = auth.currentUser;
        if (!user) {
          throw new Error('User is not authenticated.');
        }
    
        const idToken = await user.getIdToken();
    
        const response = await fetch(
          'https://us-central1-marv-studio-points-plugin.cloudfunctions.net/cancelSubscription',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${idToken}`,
            },
            body: JSON.stringify({ subscriptionId: subscriptionId }),
          }
        );
    
        const result = await response.json();
        console.log(result.message);
    
        // Return the result for handling after subscription cancellation
        return result;
    
      } catch (error) {
        console.error('Error canceling subscription:', error);
        throw error;
      }
    }
    
    
    // Function to get Checkout URL
    export const getCheckoutUrl = async function(app, priceId) {
      const auth = getAuth(app);
      const userId = auth.currentUser?.uid;
      if (!userId) throw new Error("User is not authenticated");
    
      const checkoutSessionRef = collection(
        db,
        "customers",
        userId,
        "checkout_sessions"
      );
    
      const docRef = await addDoc(checkoutSessionRef, {
        price: priceId,
        success_url: window.location.origin,
        cancel_url: window.location.origin,
      });
    
      return new Promise(function(resolve, reject) {
        const unsubscribe = onSnapshot(docRef, function(snap) {
          const { error, url } = snap.data();
          if (error) {
            unsubscribe();
            reject(new Error(`An error occurred: ${error.message}`));
          }
          if (url) {
            console.log("Stripe Checkout URL:", url);
            unsubscribe();
            resolve(url);
          }
        });
      });
    };
    
    // Function to get Portal URL
    export const getPortalUrl = async function(app) {
      const user = auth.currentUser;
    
      try {
        const functionRef = httpsCallable(
          functions,
          "ext-firestore-stripe-payments-createPortalLink"
        );
        const { data } = await functionRef({
          customerId: user?.uid,
          returnUrl: window.location.origin,
        });
    
        console.log("Reroute to Stripe portal: ", data.url);
        return data.url;
    
      } catch (error) {
        console.error(error);
        throw new Error("No url returned");
      }
    };
    
    // Function to check subscription status
    async function checkSubscriptionStatus(user, priceId) {
      try {
        const subscriptionsRef = collection(db, "customers", user.uid, "subscriptions");
        const querySnapshot = await getDocs(subscriptionsRef);
    
        let isSubscribed = false;
    
        querySnapshot.forEach((doc) => {
          const subscriptionData = doc.data();
          if (subscriptionData.items.some(item => item.price.id === priceId) && subscriptionData.status === "active") {
            isSubscribed = true;
          }
        });
    
        return isSubscribed;
    
      } catch (error) {
        console.error('Error checking subscription status:', error);
        return false;
      }
    }
    
    // Function to download BlenderBin
    async function downloadBlenderBin() {
      try {
        const url = "https://blenderbin.s3.us-east-2.amazonaws.com/BlenderBin+1.0.0.zip";
        const response = await fetch(url);
        const blob = await response.blob();
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = 'BlenderBin 1.0.0.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('Download initiated successfully.');
      } catch (error) {
        console.error('Error downloading BlenderBin:', error);
      }
    }
    
    // Function to buy BlenderBin
    function buyBlenderBin() {
      const buyBlenderBinNow = async () => {
        try {
          const priceId = "price_1Pe0T0GLCrtq5FJQe55KG3nv";
          const checkoutUrl = await getCheckoutUrl(app, priceId);
          window.location.href = checkoutUrl;
          console.log("Bought BlenderBin.");
        } catch (error) {
          console.error('Error during BlenderBin purchase:', error);
        }
      };
      buyBlenderBinNow();
    }
    
    // Listen for auth state changes
    onAuthStateChanged(auth, async (user) => {
      let publicElements = document.querySelectorAll("[data-onlogin='hide']");
      let privateElements = document.querySelectorAll("[data-onlogin='show']");
      let subscribedElements = document.querySelectorAll("[data-issubscribed='true']");
      let notSubscribedElements = document.querySelectorAll("[data-issubscribed='false']");
    
      if (user) {
        const uid = user.uid;
    
        privateElements.forEach(function(element) {
          element.style.display = "flex";
        });
    
        publicElements.forEach(function(element) {
          element.style.display = "none";
        });
    
        const priceId = "price_1Pe0T0GLCrtq5FJQe55KG3nv";
        const isSubscribed = await checkSubscriptionStatus(user, priceId);
    
        if (isSubscribed) {
          subscribedElements.forEach(function(element) {
            element.style.display = "flex";
          });
    
          notSubscribedElements.forEach(function(element) {
            element.style.display = "none";
          });
    
          if (pluginButtonsMain) {
            try {
              const downloadButton = document.createElement('button');
              downloadButton.innerText = 'Download';
              downloadButton.style.borderRadius = '50px';
              downloadButton.style.backgroundColor = '#0a0a5c';
              downloadButton.style.color = '#ffffff';
              downloadButton.style.padding = '10px 20px';
              downloadButton.style.border = 'none';
              downloadButton.style.cursor = 'pointer';
              downloadButton.style.fontFamily = 'HelveticaNowDisplayBold';
    
              downloadButton.setAttribute('data-onlogin', 'flex');
              downloadButton.setAttribute('data-issubscribed', 'true');
    
              downloadButton.addEventListener('click', downloadBlenderBin);
              pluginButtonsMain.appendChild(downloadButton);
              console.log('Download button added successfully.');
            } catch (error) {
              console.error('Error adding download button:', error);
            }
          } else {
            console.error('plugin-buttons-main element not found.');
          }
        } else {
          subscribedElements.forEach(function(element) {
            element.style.display = "none";
          });
    
          notSubscribedElements.forEach(function(element) {
            element.style.display = "flex";
          });
        }
    
        console.log(`The current user's UID is equal to ${uid}`);
      } else {
        publicElements.forEach(function(element) {
          element.style.display = "flex";
        });
    
        privateElements.forEach(function(element) {
          element.style.display = "none";
        });
    
        subscribedElements.forEach(function(element) {
          element.style.display = "none";
        });
    
        notSubscribedElements.forEach(function(element) {
          element.style.display = "flex";
        });
      }
    });
    </script>